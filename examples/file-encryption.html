<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cryptit Browser Demo â€” File Encryption</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script>
    // Required by cryptit to load the Argon2 wasm
    window.loadArgon2WasmBinary = () =>
      fetch("./assets/argon2.wasm")
        .then(r => r.arrayBuffer())
        .then(buf => new Uint8Array(buf));
  </script>
  <style>
    .dropzone {
      border: 2px dashed #ced4da;
      border-radius: .5rem;
      padding: 2rem;
      text-align: center;
      transition: background-color .15s ease-in-out, border-color .15s ease-in-out;
    }
    .dropzone.dragover {
      background-color: #f8f9fa;
      border-color: #86b7fe;
    }
    .file-list { max-height: 12rem; overflow: auto; }
    code.kv { font-size: .875rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Cryptit Demo</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#demoNav"
        aria-controls="demoNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="demoNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="text-encryption.html">Text</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="text-decoding.html">Text Decoding</a>
          </li>
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="file-encryption.html">File</a>
          </li>
         <li class="nav-item">
            <a class="nav-link" href="streaming.html">File (Streaming)</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="file-decoding.html">File Decoding</a>
        </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-1">@mqyxm/cryptit</h1>
    <h2 class="mb-4">File Encryption / Decryption Example</h2>
    <p><b>Note:</b> This example implementation processes file encryption and decryption in memory. As a result, handling large files over 50-100MB (especially on mobile devices) may cause crashes or unexpected behavior.
For large files, please use the <a href="streaming.html"> streaming</a> version and a desktop browser such as Chrome, Firefox, or Edge (iOS / Safari browsers are limited).
</p>

    <!-- Configuration -->
    <div class="card mb-4">
      <div class="card-header">Configuration</div>
      <div class="card-body">
        <form id="configForm" class="row g-3">
          <div class="col-md-4">
            <label for="secret" class="form-label">Passphrase</label>
            <input type="password" value="abc" class="form-control" id="secret" placeholder="Enter passphrase">
          </div>
          <div class="col-md-4">
            <label for="scheme" class="form-label">Scheme ID (0 - max. 7)</label>
            <input type="number" min="0" value="0" class="form-control" id="scheme">
            <div class="form-text">0 = AES-GCM / Argon2id (single thread)</div>
            <div class="form-text">1 = XChaCha20-Poly1305 / Argon2id (multithread*)</div>
            <small class="form-text">* not supported in browsers. </small>
          </div>
          <div class="col-md-4">
            <label for="difficulty" class="form-label">Argon2 Difficulty</label>
            <select id="difficulty" class="form-select">
              <option value="low">low</option>
              <option value="middle" selected>middle</option>
              <option value="high">high</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="saltStrength" class="form-label">Salt Strength</label>
            <select id="saltStrength" class="form-select">
              <option value="low">low</option>
              <option value="high" selected>high</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="verbose" class="form-label">Verbose Level</label>
            <input type="number" min="0" max="4" value="0" class="form-control" id="verbose">
            <div class="form-text">0 = errors only, 4 = maximum detail</div>
          </div>
        </form>
      </div>
    </div>

    <!-- File picker / drop area -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="fileInput" class="form-label">Choose files</label>
        <input id="fileInput" class="form-control" type="file" multiple>
        <div class="form-text">You can select one or more files.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Or drag & drop</label>
        <div id="dropZone" class="dropzone">Drop files here</div>
      </div>
    </div>

    <!-- Action buttons & error -->
    <div class="mb-3 d-flex align-items-center gap-2">
      <button id="encryptBtn" class="btn btn-primary">Encrypt</button>
      <button id="decryptBtn" class="btn btn-secondary">Decrypt</button>
      <button id="clearBtn" class="btn btn-outline-danger ms-auto">Clear results</button>
    </div>
    <div id="errorMsg" class="alert alert-danger d-none"></div>

    <!-- Results -->
    <div class="card">
      <div class="card-header">Results</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">File</th>
                <th scope="col">Operation</th>
                <th scope="col">Size</th>
                <th scope="col">Download</th>
                <th scope="col" style="width: 30%">Notes</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="text-muted mt-3 mb-0">
      <strong>Notes:</strong> Encrypted files include a self-describing header (scheme, params, salt, etc.).
      Decryption uses this embedded header automatically. You only need the passphrase.
    </p>
  </div>

  <script type="module">
    import { createCryptit } from "./assets/cryptit.browser.min.js";
    window.createCryptit = createCryptit;
  </script>

  <!-- Inline demo logic -->
  <script type="module">
    const { createCryptit } = window;

    // Shortcuts
    const $ = (id) => document.getElementById(id);
    const els = {
      secret: $('secret'),
      scheme: $('scheme'),
      difficulty: $('difficulty'),
      saltStrength: $('saltStrength'),
      verbose: $('verbose'),
      fileInput: $('fileInput'),
      dropZone: $('dropZone'),
      resultsBody: $('resultsBody'),
      error: $('errorMsg'),
      encryptBtn: $('encryptBtn'),
      decryptBtn: $('decryptBtn'),
      clearBtn: $('clearBtn'),
    };

    // Error UI
    function showError(msg) {
      els.error.textContent = msg || 'Something went wrong.';
      els.error.classList.remove('d-none');
    }
    function clearError() {
      els.error.textContent = '';
      els.error.classList.add('d-none');
    }

    // Cryptit factory
    function cryptit() {
      return createCryptit({
        scheme: Number(els.scheme.value),
        difficulty: els.difficulty.value,
        saltStrength: els.saltStrength.value,
        verbose: Number(els.verbose.value),
      });
    }

    // Helpers
    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    async function setBusy(btn, busy) {
      const other = btn === els.encryptBtn ? els.decryptBtn : els.encryptBtn;
      if (busy) {
        if (!btn.dataset.original) btn.dataset.original = btn.textContent.trim();
        btn.textContent = '...';
        btn.disabled = true;
        other.disabled = true;
        els.clearBtn.disabled = true;
        await sleep(150); // delay before locking
      } else {
        btn.textContent = btn.dataset.original || btn.textContent;
        btn.disabled = false;
        other.disabled = false;
        els.clearBtn.disabled = false;
      }
    }

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes)) return '-';
      const units = ['B','KB','MB','GB','TB'];
      const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(1024));
      return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${units[i]}`;
    }

    function suggestEncName(name = 'file') {
      return `${name}.cryptit`;
    }
    function suggestDecName(name = 'file') {
      if (name.endsWith('.cryptit')) return name.slice(0, -8);
      if (name.endsWith('.enc')) return name.slice(0, -4);
      return `${name}.decrypted`;
    }

    function makeRow({fileName, op, size, link, note}) {
      const tr = document.createElement('tr');

      const fileNameTd = document.createElement('td');
      const fileNameSpan = document.createElement('span');
      fileNameSpan.className = 'text-break';
      fileNameSpan.textContent = fileName;
      fileNameTd.append(fileNameSpan);

      const opTd = document.createElement('td');
      opTd.textContent = op;

      const sizeTd = document.createElement('td');
      sizeTd.textContent = formatBytes(size);

      const linkTd = document.createElement('td');
      if (link) linkTd.innerHTML = link; // Assumes link is trusted HTML

      const noteTd = document.createElement('td');
      const noteSmall = document.createElement('small');
      noteSmall.className = 'text-muted';
      noteSmall.textContent = note || '';
      noteTd.append(noteSmall);

      tr.append(fileNameTd, opTd, sizeTd, linkTd, noteTd);
      els.resultsBody.prepend(tr); // newest on top
    }

    function makeDownloadLink(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.textContent = 'Download';
      a.className = 'btn btn-sm btn-outline-primary';
      a.addEventListener('click', () => {
        // Revoke URL shortly after click to free memory
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      }, { once: true });
      const wrapper = document.createElement('div');
      wrapper.appendChild(a);
      return wrapper.outerHTML;
    }

    function getSelectedFiles() {
      return Array.from(els.fileInput.files || []);
    }

    function addFilesFromDataTransfer(dt) {
      const files = Array.from(dt.files || []);
      if (!files.length) return;
      // Merge with existing FileList by constructing a DataTransfer
      const current = new DataTransfer();
      Array.from(els.fileInput.files || []).forEach(f => current.items.add(f));
      files.forEach(f => current.items.add(f));
      els.fileInput.files = current.files;
    }

    // Actions
    async function encryptFiles() {
      clearError();
      const pass = els.secret.value;
      if (!pass) { showError('Passphrase is required'); return; }

      const files = getSelectedFiles();
      if (!files.length) { showError('Please choose at least one file.'); return; }

      await setBusy(els.encryptBtn, true);
      try {
        const c = cryptit();
        for (const file of files) {
          try {
            const encBlob = await c.encryptFile(file, pass);
            const name = suggestEncName(file.name || 'file');
            makeRow({
              fileName: file.name,
              op: 'Encrypted',
              size: encBlob.size,
              link: makeDownloadLink(encBlob, name),
              note: 'Header embedded; MIME: application/octet-stream',
            });
          } catch (e) {
            makeRow({
              fileName: file.name,
              op: 'Error',
              size: file.size,
              link: '',
              note: (e?.message ?? String(e)),
            });
          }
        }
      } catch (e) {
        showError(e?.message ?? String(e));
      } finally {
        await setBusy(els.encryptBtn, false);
      }
    }

    async function decryptFiles() {
      clearError();
      const pass = els.secret.value;
      if (!pass) { showError('Passphrase is required'); return; }

      const files = getSelectedFiles();
      if (!files.length) { showError('Please choose at least one encrypted file.'); return; }

      await setBusy(els.decryptBtn, true);
      try {
        const c = cryptit();
        for (const file of files) {
          try {
            // If your build exposes a different method name, change here accordingly.
            const decBlob = await c.decryptFile(file, pass);
            const name = suggestDecName(file.name || 'file');
            makeRow({
              fileName: file.name,
              op: 'Decrypted',
              size: decBlob.size,
              link: makeDownloadLink(decBlob, name),
              note: 'Derived from embedded parameters',
            });
          } catch (e) {
            makeRow({
              fileName: file.name,
              op: 'Error',
              size: file.size,
              link: '',
              note: (e?.message ?? String(e)),
            });
          }
        }
      } catch (e) {
        showError(e?.message ?? String(e));
      } finally {
        await setBusy(els.decryptBtn, false);
      }
    }

    function clearResults() {
      els.resultsBody.innerHTML = '';
      clearError();
      // Also clear file input selection
      els.fileInput.value = '';
    }

    // Drag & drop wiring
    ['dragenter','dragover'].forEach(evt => {
      els.dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        els.dropZone.classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(evt => {
      els.dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (evt === 'drop') {
          addFilesFromDataTransfer(e.dataTransfer);
        }
        els.dropZone.classList.remove('dragover');
      });
    });

    // Events
    els.encryptBtn.addEventListener('click', encryptFiles);
    els.decryptBtn.addEventListener('click', decryptFiles);
    els.clearBtn.addEventListener('click', clearResults);
  </script>
</body>
</html>
